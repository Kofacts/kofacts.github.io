---
import BaseHead from '../components/BaseHead.astro';
import { SITE_TITLE } from '../consts';

// Fetch read books from Goodreads
const GOODREADS_RSS = 'https://www.goodreads.com/review/list_rss/183340682?shelf=read';

let books = [];
try {
	const res = await fetch(GOODREADS_RSS);
	const text = await res.text();
	
	const items = text.match(/<item>[\s\S]*?<\/item>/g) || [];
	books = items.map(item => {
		const title = item.match(/<title><!\[CDATA\[(.*?)\]\]><\/title>/)?.[1] || 
			item.match(/<title>(.*?)<\/title>/)?.[1] || '';
		const author = item.match(/<author_name>(.*?)<\/author_name>/)?.[1] || '';
		const link = item.match(/<link><!\[CDATA\[(.*?)\]\]><\/link>/)?.[1] || '';
		const rating = item.match(/<user_rating>(\d+)<\/user_rating>/)?.[1] || '0';
		const imageUrl = item.match(/<book_large_image_url><!\[CDATA\[(.*?)\]\]><\/book_large_image_url>/)?.[1] ||
			item.match(/<book_medium_image_url><!\[CDATA\[(.*?)\]\]><\/book_medium_image_url>/)?.[1] || '';
		const dateRead = item.match(/<user_read_at><!\[CDATA\[(.*?)\]\]><\/user_read_at>/)?.[1] || '';
		
		return { title, author, link, rating: parseInt(rating), imageUrl, dateRead };
	}).filter(book => book.title);
} catch (e) {
	console.error('Failed to fetch Goodreads:', e);
}
---

<!doctype html>
<html lang="en">
<head>
	<BaseHead title={`Bookshelf · ${SITE_TITLE}`} description="Books I've read" />
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>

<main>
	<a href="/" class="profile-link">
		<span class="back-arrow">←</span>
		<img src="/ajabruwal.png" alt="" class="mini-avatar">
		<span class="mini-name">Rapheal Obodugo</span>
	</a>
	
	<header>
		<h1>Bookshelf</h1>
		<p class="subtitle">{books.length} books read</p>
	</header>

	<div class="books-grid">
		{books.map((book) => (
			<a href={book.link} class="book" target="_blank" rel="noopener noreferrer">
				{book.imageUrl && (
					<img src={book.imageUrl} alt={book.title} class="book-cover" loading="lazy" />
				)}
				<div class="book-info">
					<span class="book-title">{book.title}</span>
					<span class="book-author">{book.author}</span>
					{book.rating > 0 && (
						<span class="book-rating">{'★'.repeat(book.rating)}{'☆'.repeat(5 - book.rating)}</span>
					)}
				</div>
			</a>
		))}
	</div>

	<footer>
		Synced from <a href="https://www.goodreads.com/user/show/183340682" target="_blank" rel="noopener noreferrer">Goodreads</a>
	</footer>
</main>

<style is:global>
	* { margin: 0; padding: 0; box-sizing: border-box; }
	
	body {
		font-family: 'Inter', system-ui, sans-serif;
		background: #09090b;
		color: #a1a1aa;
		line-height: 1.65;
		-webkit-font-smoothing: antialiased;
	}
	
	main {
		max-width: 640px;
		margin: 0 auto;
		padding: 80px 24px 100px;
	}
	
	.profile-link {
		display: flex;
		align-items: center;
		gap: 10px;
		text-decoration: none;
		margin-bottom: 40px;
	}
	
	.back-arrow {
		font-size: 14px;
		color: #52525b;
		transition: transform 0.2s, color 0.2s;
	}
	
	.profile-link:hover .back-arrow {
		transform: translateX(-3px);
		color: #71717a;
	}
	
	.mini-avatar {
		width: 32px;
		height: 32px;
		border-radius: 50%;
		opacity: 0.9;
	}
	
	.mini-name {
		font-size: 14px;
		color: #71717a;
		transition: color 0.2s;
	}
	
	.profile-link:hover .mini-name {
		color: #a1a1aa;
	}
	
	header {
		margin-bottom: 40px;
	}
	
	h1 {
		font-size: 20px;
		font-weight: 600;
		color: #fafafa;
		letter-spacing: -0.02em;
		margin-bottom: 4px;
	}
	
	.subtitle {
		font-size: 14px;
		color: #52525b;
	}
	
	.books-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
		gap: 24px;
		margin-bottom: 56px;
	}
	
	.book {
		display: flex;
		flex-direction: column;
		gap: 10px;
		text-decoration: none;
		perspective: 800px;
	}
	
	.book-cover {
		width: 100%;
		height: auto;
		aspect-ratio: 2/3;
		object-fit: cover;
		border-radius: 4px;
		box-shadow: 
			0 8px 24px rgba(0, 0, 0, 0.4),
			inset 4px 0 8px -4px rgba(0, 0, 0, 0.3);
		transition: transform 0.4s ease, box-shadow 0.4s ease;
		transform-style: preserve-3d;
	}
	
	.book:hover .book-cover {
		transform: rotateY(-12deg) rotateX(4deg) scale(1.03);
		box-shadow: 
			12px 16px 32px rgba(0, 0, 0, 0.5),
			inset 6px 0 12px -4px rgba(0, 0, 0, 0.4);
	}
	
	.book-info {
		display: flex;
		flex-direction: column;
		gap: 2px;
	}
	
	.book-title {
		font-size: 13px;
		color: #d4d4d8;
		line-height: 1.3;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
	
	.book-author {
		font-size: 12px;
		color: #52525b;
	}
	
	.book-rating {
		font-size: 11px;
		color: #52525b;
		letter-spacing: 1px;
	}
	
	footer {
		padding-top: 32px;
		border-top: 1px solid #18181b;
		font-size: 12px;
		color: #27272a;
	}
	
	footer a {
		color: #3f3f46;
		text-decoration: none;
		transition: color 0.2s;
	}
	
	footer a:hover {
		color: #52525b;
	}
	
	@media (max-width: 520px) {
		main { padding: 48px 20px 64px; }
		.books-grid { grid-template-columns: repeat(2, 1fr); }
	}
</style>

</body>
</html>
